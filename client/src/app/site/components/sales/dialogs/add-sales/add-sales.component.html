<div class="grid p-fluid">
  <div class="col-12">
    <form [formGroup]="addSaleForm" novalidate>
      <div class="formgrid grid">
        <div class="field col">
          <label for="agent">Контрагент</label>
          <p-dropdown
            placeholder="Choose.."
            [options]="agentService.agents"
            formControlName="agentId"
            optionLabel="fullName"
            optionValue="id"
            appendTo="body"
          >
          </p-dropdown>
        </div>
        <div class="field col">
          <label for="shift">Зміна</label>
          <input type="text" pInputText formControlName="shift" />
        </div>
      </div>
      <div class="field product-list" formArrayName="products">
        <label for="prod">Товари</label>
        <ng-container
          id="prod"
          *ngFor="let product of products.controls; let i = index"
        >
          <div class="formgrid grid product-list-inputs" [formGroupName]="i">
            <div class="field col-12 md:col-7">
              <p-dropdown
                [options]="goodsService.leavings"
                formControlName="productId"
                optionLabel="product.name"
                [showClear]="false"
                placeholder="Оберіть товар.."
                [filter]="true"
                filterBy="code,name"
                appendTo="body"
              >
                <ng-template pTemplate="selectedItem">
                  <div *ngIf="!!products.controls[i].get('productId')">
                    <div class="flex justify-content-between">
                      <div>
                        <span>
                          {{
                            products.controls[i].get("productId")?.value.product
                              .code
                          }}
                          {{
                            products.controls[i].get("productId")?.value.product
                              .name
                          }}
                        </span>
                      </div>
                      <div>
                        <span
                          class="p-1 border-round-md"
                          [ngClass]="
                            products.controls[i].get('productId')?.value
                              .inStockCount === 0
                              ? 'bg-red-300'
                              : 'bg-green-400'
                          "
                        >
                          {{
                            products.controls[i].get("productId")?.value
                              .inStockCount
                          }}</span
                        >
                      </div>
                    </div>
                  </div>
                </ng-template>
                <ng-template let-product pTemplate="item">
                  <div class="dropdown-items-list">
                    <span
                      >{{ product.product.code }}
                      {{ product.product.name }}</span
                    >
                    <span
                      class="p-1 border-round-md"
                      [ngClass]="
                        product.inStockCount === 0
                          ? 'bg-red-300'
                          : 'bg-green-400'
                      "
                      >{{ product.inStockCount }}</span
                    >
                  </div>
                </ng-template>
              </p-dropdown>
            </div>
            <div class="field col-12 md:col-2">
              <p-inputNumber
                formControlName="pricePerItem"
                placeholder="Ціна"
                (ngModelChange)="total()"
              ></p-inputNumber>
            </div>
            <div class="field col-12 md:col-2">
              <p-inputNumber
                formControlName="count"
                mode="decimal"
                [useGrouping]="false"
                placeholder="Кількість"
                [min]="1"
                [max]="
                  products.controls[i].get('productId')?.value.inStockCount
                "
                (ngModelChange)="total()"
              ></p-inputNumber>
            </div>
            <div class="field col-12 md:col-1" *ngIf="i !== 0">
              <button
                pButton
                type="button"
                class="p-button-rounded p-button-danger p-button-text"
                icon="pi pi-times"
                (click)="removeProductControl(i)"
              ></button>
            </div>
            <div class="field col-12 md:col-1" *ngIf="i === 0">
              <button
                pButton
                type="button"
                class="p-button-rounded p-button-success p-button-text"
                icon="pi pi-plus"
                (click)="addProducts()"
              ></button>
            </div>
          </div>
        </ng-container>
      </div>
      <div class="results flex flex-column gap-2">
        <div class="results-data flex justify-content-between flex-wrap">
          <span>До оплати:</span>
          <span>{{ totalCount | currency : "UAH" : "UAH " }}</span>
        </div>
        <div class="results-inputs">
          <p-dropdown
            appendTo="body"
            [options]="typesOfPaying"
            optionLabel="label"
            optionValue="typeId"
          ></p-dropdown>
        </div>
      </div>
      <div class="field">
        <button
          class="save_btn"
          pButton
          label="Зберегти"
          form="postingForm"
          type="submit"
          [disabled]="addSaleForm.invalid"
        ></button>
      </div>
    </form>
  </div>
</div>
